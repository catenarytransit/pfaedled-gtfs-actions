name: National Rail UK GTFS Update

on:
  workflow_call:
    secrets:
      NR_USERNAME:
        required: true
      NR_PASSWORD:
        required: true

jobs:
  update-nationalrailuk:
    runs-on: ubuntu-latest
    env:
      NR_USERNAME: ${{ secrets.NR_USERNAME }}
      NR_PASSWORD: ${{ secrets.NR_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y zip gh

      - name: Checkout nationalrail-gtfs
        uses: actions/checkout@v4
        with:
          repository: catenarytransit/nationalrail-gtfs
          path: nationalrail-gtfs

      - name: Build nationalrail-gtfs
        run: |
          cd nationalrail-gtfs
          cargo build --release

      - name: Run nationalrail-gtfs
        run: |
          cd nationalrail-gtfs
          NR_USERNAME="$NR_USERNAME" NR_PASSWORD="$NR_PASSWORD" ./target/release/nationalrail-gtfs

      - name: Zip output
        run: |
          sh zip.sh

      - name: Upload to latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload latest nationalrailuk.zip --clobber
